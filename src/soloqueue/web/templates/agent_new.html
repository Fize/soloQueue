{% extends "base.html" %}

{% block title %}New Agent | SoloQueue{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 small">
            <li class="breadcrumb-item"><a href="/agents">Agents</a></li>
            <li class="breadcrumb-item active">New</li>
        </ol>
    </nav>
</div>

<div class="card shadow-sm border-0" x-data="agentCreator()">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Create New Agent</h5>
        <div>
            <a href="/agents" class="btn btn-outline-secondary btn-sm me-2">Cancel</a>
            <button @click="create" class="btn btn-primary btn-sm" :disabled="saving">
                <span x-show="saving" class="spinner-border spinner-border-sm me-1" role="status"
                    aria-hidden="true"></span>
                <span x-text="saving ? 'Creating...' : 'Create Agent'"></span>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div x-show="error" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span x-text="error"></span>
            <button type="button" class="btn-close" @click="error = ''"></button>
        </div>
        <form @submit.prevent="create">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" x-model="agent.name" required
                        pattern="[a-zA-Z0-9_-]+" placeholder="e.g. my-agent">
                    <div class="form-text">Letters, numbers, hyphens, underscores only.</div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Group</label>
                    <select class="form-select" x-model="agent.group">
                        <option value="">-- No Group --</option>
                        {% for g in groups %}
                        <option value="{{ g }}">{{ g }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label fw-bold">Description <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" x-model="agent.description" required
                        placeholder="Brief description of this agent's role">
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Model</label>
                    <input type="text" class="form-control" x-model="agent.model"
                        placeholder="e.g. claude-sonnet-4-20250514">
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Role</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="isLeader" x-model="agent.is_leader">
                        <label class="form-check-label" for="isLeader">Is Leader?</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Reasoning</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="reasoning" x-model="agent.reasoning">
                        <label class="form-check-label" for="reasoning">Enable Reasoning</label>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Memory (Context File Path)</label>
                    <input type="text" class="form-control" x-model="agent.memory" placeholder="e.g. context/knowledge.md">
                    <div class="form-text">Relative path to context file.</div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Color</label>
                    <div class="input-group">
                        <input type="color" class="form-control form-control-color" x-model="agent.color"
                            style="max-width: 50px;">
                        <input type="text" class="form-control" x-model="agent.color" placeholder="#2563eb">
                    </div>
                    <div class="form-text">CSS color for UI display.</div>
                </div>

                <div class="col-12">
                    <label class="form-label fw-bold">System Prompt</label>
                    <textarea class="form-control font-monospace small" rows="15" x-model="agent.system_prompt"
                        style="font-size: 0.85rem;" placeholder="Agent system prompt in Markdown..."></textarea>
                    <div class="form-text">Markdown supported.</div>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Tools (comma separated)</label>
                    <input type="text" class="form-control" x-model="toolsStr"
                        @input="agent.tools = $event.target.value.split(',').map(s => s.trim()).filter(s => s)"
                        placeholder="read_file, web_fetch, date-teller">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Sub-Agents (comma separated)</label>
                    <input type="text" class="form-control" x-model="subAgentsStr"
                        @input="agent.sub_agents = $event.target.value.split(',').map(s => s.trim()).filter(s => s)"
                        placeholder="analyst, trader">
                </div>
            </div>

        </form>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('agentCreator', () => ({
            agent: {
                name: '',
                description: '',
                group: '{{ default_group }}',
                model: '',
                is_leader: false,
                reasoning: false,
                system_prompt: '',
                tools: [],
                sub_agents: [],
                memory: '',
                color: '#2563eb'
            },
            toolsStr: '',
            subAgentsStr: '',
            saving: false,
            error: '',

            async create() {
                this.error = '';
                if (!this.agent.name.trim() || !this.agent.description.trim()) {
                    this.error = 'Name and Description are required.';
                    return;
                }

                this.saving = true;
                try {
                    const res = await fetch('/api/agents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.agent)
                    });
                    const data = await res.json();

                    if (res.ok && data.status === 'success') {
                        window.location.href = `/agents/${data.name}`;
                    } else {
                        this.error = data.message || 'Unknown error';
                    }
                } catch (e) {
                    this.error = 'Network error: ' + e;
                } finally {
                    this.saving = false;
                }
            }
        }))
    })
</script>
{% endblock %}
